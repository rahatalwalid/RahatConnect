<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RahatConnect</title>
    
    <!-- Google Font: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">

    <!-- Firebase v8 SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --bg-color: #0f0f2d;
            --text-color: #ffffff;
            --primary-color: #e94560; /* Neon Pink */
            --secondary-color: #3a8bfd; /* Neon Blue */
            --container-bg: rgba(255, 255, 255, 0.05);
            --sent-bubble-bg: #3a8bfd;
            --received-bubble-bg: #33335a;
            --danger-color: #dc3545;
        }

        body.light-theme {
            --bg-color: #f0f2f5;
            --text-color: #0f0f2d;
            --container-bg: #ffffff;
            --sent-bubble-bg: #3a8bfd;
            --received-bubble-bg: #e4e6eb;
            --danger-color: #c82333;
        }

        /* --- GLOBAL STYLES --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        #app-container {
            width: 100%;
            max-width: 450px;
            height: 100vh;
            max-height: 900px;
            background-color: var(--bg-color);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* --- AUTH VIEW --- */
        .auth-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            height: 100%;
        }

        .auth-view h1 {
            font-size: 36px;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color);
            margin-bottom: 40px;
        }
        
        .auth-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .auth-form input {
            border-radius: 25px;
            border: 2px solid var(--secondary-color);
            background: transparent;
            color: var(--text-color);
            padding: 12px 20px;
            max-width: 350px;
            width: 100%;
            font-size: 16px;
        }

        .auth-form input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        body.light-theme .auth-form input::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }

        .auth-form button {
            border-radius: 50px;
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            border: none;
            padding: 12px 20px;
            width: 100%;
            max-width: 350px;
            cursor: pointer;
            transition: box-shadow 0.3s ease, transform 0.2s ease;
            font-size: 16px;
        }
        .auth-form button:disabled {
            background-color: #888;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .auth-form button:hover:not(:disabled) {
            box-shadow: 0 0 15px var(--primary-color), 0 0 25px var(--primary-color);
            transform: translateY(-2px);
        }
        
        .form-switch {
            color: var(--text-color);
            font-size: 13px;
            margin-top: 20px;
        }

        .form-switch a {
            color: var(--primary-color);
            text-decoration: underline;
            font-weight: bold;
            cursor: pointer;
        }
        
        .error-message {
            color: #ff4d4d;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            min-height: 20px;
        }

        /* --- MAIN APP VIEW --- */
        #main-app-view {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        header, footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--container-bg);
            flex-shrink: 0;
        }
        
        header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        header h1 {
            font-size: 20px;
            color: var(--primary-color);
            text-shadow: 0 0 5px var(--primary-color);
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 16px;
            padding: 5px 10px;
            position: relative;
        }
        
        .badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            width: 18px;
            height: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            transform: translate(50%, -50%);
        }

        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .list-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: var(--container-bg);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        .list-item-main {
             flex-grow: 1;
             display: flex;
             align-items: center;
             cursor: pointer;
             min-width: 0;
        }
        
        .item-emoji {
            font-size: 24px;
            margin-right: 15px;
        }

        .item-info {
            flex-grow: 1;
            min-width: 0;
        }

        .item-name {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .item-detail {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        body.light-theme .item-detail {
            color: rgba(0,0,0,0.6);
        }

        .item-actions {
            display: flex;
            flex-shrink: 0;
            gap: 5px;
            margin-left: 10px;
        }

        .item-actions button {
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .item-actions .danger-btn,
        .item-actions .reject-btn {
            background-color: var(--danger-color);
        }

        /* --- CHAT PAGE --- */
        #chat-page {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        #chat-header {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: var(--container-bg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .sent {
            background-color: var(--sent-bubble-bg);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .received {
            background-color: var(--received-bubble-bg);
            color: var(--text-color);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        #chat-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #chat-input {
            flex-grow: 1;
            background: var(--container-bg);
            border: 1px solid var(--secondary-color);
            color: var(--text-color);
            border-radius: 20px;
            padding: 10px 15px;
        }

        #send-message-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            margin-left: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-color);
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--secondary-color);
            box-shadow: 0 0 20px var(--secondary-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 80vh;
        }
        
        .modal-body {
            overflow-y: auto;
            padding-right: 10px;
        }

        .modal-content h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .modal-content input, .modal-content button {
            width: 100%;
        }

        .modal-content input {
            border-radius: 25px;
            border: 2px solid var(--secondary-color);
            background: transparent;
            color: var(--text-color);
            padding: 12px 20px;
            font-size: 16px;
        }

        .modal-content button {
            border-radius: 50px;
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
        }
        
        .modal-content .button-group {
            display: flex;
            gap: 10px;
        }

        .modal-content button.secondary {
            background-color: #555;
        }
        .modal-content button:disabled {
            background-color: #888;
            cursor: not-allowed;
        }

        /* --- CALL UI --- */
        #call-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #remote-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 25%;
            max-width: 150px;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            cursor: move;
            z-index: 2001;
        }

        .call-info {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2002;
            background-color: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
        }
        
        .call-info .caller-emoji {
            font-size: 40px;
        }

        .call-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2002;
            display: flex;
            gap: 20px;
        }

        .call-controls button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        #end-call-btn {
            background-color: var(--primary-color);
            color: white;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- AUTH VIEW -->
        <div id="auth-view" class="auth-view">
            <h1 id="app-title">RahatConnect</h1>
            <div id="login-form" class="auth-form">
                <input type="email" id="login-email" placeholder="Email">
                <input type="password" id="login-password" placeholder="Password">
                <button id="login-btn">Log In</button>
                <p class="error-message" id="login-error"></p>
                <p class="form-switch">Don't have an account? <a id="show-signup">Sign up</a></p>
            </div>
            <div id="signup-form" class="auth-form" style="display: none;">
                <input type="email" id="signup-email" placeholder="Email">
                <input type="password" id="signup-password" placeholder="Password">
                <button id="signup-btn">Sign Up</button>
                <p class="error-message" id="signup-error"></p>
                <p class="form-switch">Already have an account? <a id="show-login">Log in</a></p>
            </div>
        </div>

        <!-- MAIN APP VIEW -->
        <div id="main-app-view" style="display: none;">
            <header>
                <button id="menu-btn" class="nav-btn">Menu</button>
                <h1>RahatConnect</h1>
                <button id="add-friend-btn" class="nav-btn">Add Friend</button>
            </header>
            <main id="content-pages">
                <div id="home-page" class="page active"><div id="contact-list"></div></div>
                <div id="notifications-page" class="page"><h2>Friend Requests</h2><div id="notification-list"></div></div>
                <div id="calls-page" class="page"><h2>Call Logs</h2><div id="call-log-list"></div></div>
            </main>
            <div id="chat-page" class="page">
                <div id="chat-header">
                    <button id="back-to-home-btn" class="nav-btn">Back</button>
                    <div class="item-emoji" id="chat-header-emoji"></div>
                    <div class="item-info"><div class="item-name" id="chat-header-name"></div></div>
                </div>
                <div id="chat-messages"></div>
                <div id="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Type a message..."><button id="send-message-btn">Send</button>
                </div>
            </div>
            <footer>
                <button id="nav-home" class="nav-btn">Home</button>
                <button id="nav-notifications" class="nav-btn">Notifications</button>
                <button id="nav-calls" class="nav-btn">Calls</button>
            </footer>
        </div>
    </div>

    <!-- MODALS & OVERLAYS -->
    <div id="profile-setup-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Setup Your Profile</h2>
            <input type="text" id="profile-name-input" placeholder="Your Name"><input type="text" id="profile-emoji-input" placeholder="Your Emoji (max 2)" maxlength="2"><button id="save-profile-btn">Save Profile</button>
        </div>
    </div>
    <div id="incoming-call-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="incoming-call-type">Incoming Call</h2>
            <div style="text-align: center;"><div id="incoming-caller-emoji" style="font-size: 48px;"></div><h3 id="incoming-caller-name"></h3></div>
            <div class="button-group"><button id="reject-call-btn" class="secondary">Reject</button><button id="accept-call-btn">Accept</button></div>
        </div>
    </div>
    <div id="menu-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Menu</h2>
            <button id="menu-profile-btn">My Profile</button><button id="menu-blocked-btn">Blocked Users</button><button id="menu-theme-btn">Toggle Theme</button><button id="menu-logout-btn" class="secondary">Logout</button><button id="menu-close-btn" class="secondary">Close</button>
        </div>
    </div>
    <div id="my-profile-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>My Profile</h2>
            <p><strong>Name:</strong> <span id="profile-view-name"></span></p><p><strong>Emoji:</strong> <span id="profile-view-emoji"></span></p><p><strong>ID:</strong> <span id="profile-view-id"></span></p>
            <input type="text" id="profile-edit-name" style="display:none;"><input type="text" id="profile-edit-emoji" style="display:none;" maxlength="2">
            <button id="profile-edit-btn">Edit</button><button id="profile-save-changes-btn" style="display:none;">Save Changes</button><button id="profile-close-btn" class="secondary">Close</button>
        </div>
    </div>
    <div id="blocked-users-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Blocked Users</h2>
            <div id="blocked-list" class="modal-body"></div>
            <button id="blocked-users-close-btn" class="secondary">Close</button>
        </div>
    </div>

    <!-- CALL VIEW -->
    <div id="call-view">
        <video id="remote-video" autoplay playsinline></video><video id="local-video" autoplay playsinline muted></video>
        <div class="call-info"><div class="caller-emoji" id="call-view-emoji"></div><h3 id="call-view-name"></h3><p id="call-view-status">Connecting...</p></div>
        <div class="call-controls"><button id="end-call-btn">End</button></div>
    </div>
    
    <!-- RINGTONE -->
    <audio id="ringtone" src="https://github.com/rahatalwalid/RahatConnect-Sound/raw/refs/heads/main/incoming.wav" loop></audio>

    <script>
        // --- FIREBASE CONFIGURATION & INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCyi55rVrsBtF9HpqMWz2a4H4ggwSkJ6z4",
            authDomain: "rahatconnect-e9755.firebaseapp.com",
            databaseURL: "https://rahatconnect-e9755-default-rtdb.firebaseio.com",
            projectId: "rahatconnect-e9755",
            storageBucket: "rahatconnect-e9755.appspot.com",
            messagingSenderId: "326989187761",
            appId: "1:326989187761:web:b2800fdbadb32b2a3af090"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- GLOBAL STATE ---
        let currentUser;
        let currentUserProfile;
        let blockedUsers = {};
        let currentChatPartner;
        let currentChatId;
        let localStream;
        let remoteStream;
        let peerConnection;
        let incomingCallData;
        let activeListeners = {};
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // --- DOM ELEMENTS (Cached for performance) ---
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const ringtone = document.getElementById('ringtone');

        // --- APP INITIALIZATION & LIFECYCLE ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
            }
            
            setupEventListeners();

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    try {
                        const profile = await fetchUserProfile(user.uid);
                        if (profile && profile.name) {
                            currentUserProfile = profile;
                            initializeAppUI();
                        } else {
                            showProfileSetup();
                        }
                    } catch (error) {
                        console.error("Critical error during profile fetch:", error);
                        showAuthView();
                    }
                } else {
                    showAuthView();
                }
            });
        });

        function initializeAppUI() {
            cleanupListeners();
            showPage('home-page');
            authView.style.display = 'none';
            mainAppView.style.display = 'flex';
            listenForBlockedUsers();
            listenForContacts();
            listenForFriendRequests();
            listenForNotifications();
            listenForCallLogs();
            listenForIncomingCalls();
            listenForUnreadMessages();
        }

        function cleanupListeners() {
            Object.values(activeListeners).forEach(ref => {
                if (ref && typeof ref.off === 'function') {
                    ref.off();
                }
            });
            activeListeners = {};
        }

        // --- UI & VIEW MANAGEMENT ---
        function showPage(pageId) {
            document.querySelectorAll('#main-app-view .page').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if(targetPage) targetPage.classList.add('active');
            const isChatPage = (pageId === 'chat-page');
            document.getElementById('content-pages').style.display = isChatPage ? 'none' : 'block';
            document.getElementById('chat-page').style.display = isChatPage ? 'flex' : 'none';
        }

        function showAuthView() {
            currentUser = null; currentUserProfile = null; blockedUsers = {};
            cleanupListeners();
            authView.style.display = 'flex';
            mainAppView.style.display = 'none';
        }

        function showProfileSetup() {
            authView.style.display = 'none';
            mainAppView.style.display = 'none';
            document.getElementById('profile-setup-modal').style.display = 'flex';
        }

        async function showChatPage(partnerData) {
            if (!partnerData || !partnerData.uid) {
                alert("Invalid chat partner");
                return;
            }

            // Check blocking status both ways
            const isBlockedByMe = blockedUsers[partnerData.uid];
            const heBlockedMe = (await db.ref(`/blocked/${partnerData.uid}/${currentUser.uid}`).once('value')).exists();
            
            if (isBlockedByMe) {
                alert(`You have blocked ${partnerData.name}.`);
                return;
            }
            
            if (heBlockedMe) {
                alert(`${partnerData.name} has blocked you.`);
                return;
            }

            currentChatPartner = partnerData;
            currentChatId = getChatId(currentUser.uid, partnerData.uid);
            
            if (!currentChatId) {
                alert("Failed to start chat");
                return;
            }

            showPage('chat-page');
            document.getElementById('chat-header-emoji').textContent = partnerData.emoji;
            document.getElementById('chat-header-name').textContent = partnerData.name;
            loadChatMessages(currentChatId);
            db.ref(`/unreadCounts/${currentUser.uid}/${currentChatId}`).set(0);
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('show-signup').addEventListener('click', () => { 
                document.getElementById('login-form').style.display = 'none'; 
                document.getElementById('signup-form').style.display = 'block'; 
            });
            document.getElementById('show-login').addEventListener('click', () => { 
                document.getElementById('signup-form').style.display = 'none'; 
                document.getElementById('login-form').style.display = 'block'; 
            });
            document.getElementById('signup-btn').addEventListener('click', handleSignup);
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('save-profile-btn').addEventListener('click', handleProfileSetup);
            document.getElementById('nav-home').addEventListener('click', () => showPage('home-page'));
            document.getElementById('nav-notifications').addEventListener('click', () => showPage('notifications-page'));
            document.getElementById('nav-calls').addEventListener('click', () => showPage('calls-page'));
            document.getElementById('back-to-home-btn').addEventListener('click', () => { 
                showPage('home-page'); 
                if (currentChatId && activeListeners[currentChatId]) { 
                    activeListeners[currentChatId].off(); 
                    delete activeListeners[currentChatId]; 
                } 
                currentChatId = null; 
                currentChatPartner = null; 
            });
            document.getElementById('add-friend-btn').addEventListener('click', handleAddFriend);
            document.getElementById('menu-btn').addEventListener('click', () => document.getElementById('menu-modal').style.display = 'flex');
            document.getElementById('menu-close-btn').addEventListener('click', () => document.getElementById('menu-modal').style.display = 'none');
            document.getElementById('menu-logout-btn').addEventListener('click', () => auth.signOut());
            document.getElementById('menu-theme-btn').addEventListener('click', toggleTheme);
            document.getElementById('menu-profile-btn').addEventListener('click', showMyProfile);
            document.getElementById('profile-close-btn').addEventListener('click', () => document.getElementById('my-profile-modal').style.display = 'none');
            document.getElementById('profile-edit-btn').addEventListener('click', toggleProfileEdit);
            document.getElementById('profile-save-changes-btn').addEventListener('click', saveProfileChanges);
            document.getElementById('menu-blocked-btn').addEventListener('click', showBlockedUsers);
            document.getElementById('blocked-users-close-btn').addEventListener('click', () => document.getElementById('blocked-users-modal').style.display = 'none');
            document.getElementById('send-message-btn').addEventListener('click', handleSendMessage);
            document.getElementById('chat-input').addEventListener('keypress', e => { if (e.key === 'Enter') handleSendMessage() });
            document.getElementById('accept-call-btn').addEventListener('click', handleAcceptCall);
            document.getElementById('reject-call-btn').addEventListener('click', handleRejectCall);
            document.getElementById('end-call-btn').addEventListener('click', endCall);
            makeElementDraggable(document.getElementById('local-video'));
        }

        // --- AUTHENTICATION & PROFILE ---
        function handleSignup() { 
            const email = document.getElementById('signup-email').value, 
                  pass = document.getElementById('signup-password').value, 
                  err = document.getElementById('signup-error'); 
            err.textContent = ''; 
            auth.createUserWithEmailAndPassword(email, pass).catch(e => err.textContent = e.message); 
        }

        function handleLogin() { 
            const email = document.getElementById('login-email').value, 
                  pass = document.getElementById('login-password').value, 
                  err = document.getElementById('login-error'); 
            err.textContent = ''; 
            auth.signInWithEmailAndPassword(email, pass).catch(e => err.textContent = e.message); 
        }

        async function fetchUserProfile(uid) { 
            return (await db.ref(`/users/${uid}`).once('value')).val(); 
        }

        async function handleProfileSetup() {
            const name = document.getElementById('profile-name-input').value.trim(), 
                  emoji = document.getElementById('profile-emoji-input').value.trim(), 
                  btn = document.getElementById('save-profile-btn');
            if (!name || !emoji) { 
                return alert('Please fill out both name and emoji.'); 
            }
            btn.disabled = true; 
            btn.textContent = 'Saving...';
            try { 
                const connectId = await generateUniqueConnectId(); 
                await db.ref(`/users/${currentUser.uid}`).set({ name, emoji, connectId, uid: currentUser.uid }); 
                document.getElementById('profile-setup-modal').style.display = 'none'; 
            } catch(error) { 
                alert('Could not save profile.'); 
                console.error("Profile save error:", error); 
            } finally { 
                btn.disabled = false; 
                btn.textContent = 'Save Profile'; 
            }
        }

        async function generateUniqueConnectId() { 
            let id, exists; 
            do { 
                id = `Connect-${Math.floor(1000 + Math.random() * 9000)}`; 
                exists = (await db.ref('users').orderByChild('connectId').equalTo(id).once('value')).exists(); 
            } while (exists); 
            return id; 
        }

        function showMyProfile() { 
            document.getElementById('menu-modal').style.display = 'none'; 
            document.getElementById('my-profile-modal').style.display = 'flex'; 
            document.getElementById('profile-view-name').textContent = currentUserProfile.name; 
            document.getElementById('profile-view-emoji').textContent = currentUserProfile.emoji; 
            document.getElementById('profile-view-id').textContent = currentUserProfile.connectId; 
            document.getElementById('profile-edit-name').style.display = 'none'; 
            document.getElementById('profile-edit-emoji').style.display = 'none'; 
            document.getElementById('profile-save-changes-btn').style.display = 'none'; 
            document.getElementById('profile-edit-btn').style.display = 'block'; 
        }

        function toggleProfileEdit() { 
            document.getElementById('profile-edit-btn').style.display = 'none'; 
            document.getElementById('profile-save-changes-btn').style.display = 'block'; 
            const nameInput = document.getElementById('profile-edit-name'), 
                  emojiInput = document.getElementById('profile-edit-emoji'); 
            nameInput.value = currentUserProfile.name; 
            emojiInput.value = currentUserProfile.emoji; 
            nameInput.style.display = 'block'; 
            emojiInput.style.display = 'block'; 
        }

        async function saveProfileChanges() { 
            const newName = document.getElementById('profile-edit-name').value.trim(), 
                  newEmoji = document.getElementById('profile-edit-emoji').value.trim(); 
            if (!newName || !newEmoji) return alert('Name and emoji cannot be empty.'); 
            await db.ref(`/users/${currentUser.uid}`).update({ name: newName, emoji: newEmoji }); 
            currentUserProfile.name = newName; 
            currentUserProfile.emoji = newEmoji; 
            showMyProfile(); 
        }

        // --- FRIEND & BLOCK SYSTEM ---
        async function handleAddFriend() {
            const friendId = prompt('Enter the Connect-ID of the user:');
            if (!friendId) return;
            
            const snapshot = await db.ref('users').orderByChild('connectId').equalTo(friendId.trim()).once('value');
            if (!snapshot.exists()) return alert('User not found.');
            
            const recipientUid = Object.keys(snapshot.val())[0];
            if (recipientUid === currentUser.uid) return alert("You can't add yourself!");
            
            if ((await db.ref(`/contacts/${currentUser.uid}/${recipientUid}`).once('value')).exists()) 
                return alert("You are already friends.");
            
            if ((await db.ref(`/requests/${recipientUid}/${currentUser.uid}`).once('value')).exists()) 
                return alert("A friend request has already been sent.");
            
            await db.ref(`/requests/${recipientUid}/${currentUser.uid}`).set({ 
                from: currentUser.uid, 
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            });
            
            await db.ref(`/notifications/${recipientUid}`).push({ 
                type: 'friend_request',
                from: currentUser.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            alert('Friend request sent!');
        }

        async function handleFriendRequest(senderUid, accepted) {
            const myUid = currentUser.uid;

            // 1. Remove the request object
            await db.ref(`/requests/${myUid}/${senderUid}`).remove();

            // 2. Find and remove the corresponding notification pointer
            const notifSnapshot = await db.ref(`/notifications/${myUid}`).orderByChild('from').equalTo(senderUid).once('value');
            if (notifSnapshot.exists()) {
                const notifKey = Object.keys(notifSnapshot.val())[0];
                await db.ref(`/notifications/${myUid}/${notifKey}`).remove();
            }
            
            // 3. If accepted, create contacts for both users
            if (accepted) {
                await db.ref(`/contacts/${myUid}/${senderUid}`).set({ 
                    addedAt: firebase.database.ServerValue.TIMESTAMP 
                });
                await db.ref(`/contacts/${senderUid}/${myUid}`).set({ 
                    addedAt: firebase.database.ServerValue.TIMESTAMP 
                });
            }
        }

        async function showBlockedUsers() {
            document.getElementById('menu-modal').style.display = 'none';
            document.getElementById('blocked-users-modal').style.display = 'flex';
            const listEl = document.getElementById('blocked-list'); 
            listEl.innerHTML = '';
            
            if (Object.keys(blockedUsers).length === 0) { 
                listEl.innerHTML = '<p>You have not blocked any users.</p>'; 
                return; 
            }
            
            for (const uid in blockedUsers) {
                const profile = await fetchUserProfile(uid);
                if (profile) {
                    const itemEl = document.createElement('div'); 
                    itemEl.className = 'list-item';
                    itemEl.innerHTML = `
                        <div class="list-item-main">
                            <div class="item-emoji">${profile.emoji}</div>
                            <div class="item-info">
                                <div class="item-name">${profile.name}</div>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="unblock-btn" data-uid="${uid}">Unblock</button>
                        </div>`;
                    itemEl.querySelector('.unblock-btn').addEventListener('click', e => 
                        db.ref(`/blocked/${currentUser.uid}/${e.target.dataset.uid}`).remove());
                    listEl.appendChild(itemEl);
                }
            }
        }

        // --- DATABASE LISTENERS ---
        function listenForBlockedUsers() { 
            const ref = db.ref(`/blocked/${currentUser.uid}`); 
            activeListeners.blocked = ref; 
            ref.on('value', snap => { 
                blockedUsers = snap.val() || {}; 
                listenForContacts(); 
            }); 
        }

        function listenForContacts() {
            const ref = db.ref(`/contacts/${currentUser.uid}`);
            if (activeListeners.contacts) { 
                activeListeners.contacts.off(); 
            }
            activeListeners.contacts = ref;
            ref.on('value', snap => {
                const listEl = document.getElementById('contact-list'); 
                listEl.innerHTML = '';
                
                if (!snap.exists()) { 
                    listEl.innerHTML = '<p>Add friends to start chatting!</p>'; 
                    return; 
                }
                
                snap.forEach(child => {
                    fetchUserProfile(child.key).then(profile => {
                        if (profile) {
                            const itemEl = document.createElement('div'); 
                            itemEl.className = 'list-item';
                            itemEl.innerHTML = `
                                <div class="list-item-main">
                                    <div class="item-emoji">${profile.emoji}</div>
                                    <div class="item-info">
                                        <div class="item-name">${profile.name}</div>
                                        <div class="item-detail">${profile.connectId}</div>
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <button class="call-btn" data-type="voice">Call</button>
                                    <button class="call-btn" data-type="video">Video</button>
                                    <button class="block-btn danger-btn">Block</button>
                                    <button class="delete-chat-btn danger-btn">Delete</button>
                                </div>`;
                            
                            itemEl.querySelector('.list-item-main').addEventListener('click', () => showChatPage(profile));
                            itemEl.querySelectorAll('.call-btn').forEach(btn => 
                                btn.addEventListener('click', e => { 
                                    e.stopPropagation(); 
                                    initiateCall(profile.uid, e.target.dataset.type); 
                                }));
                            itemEl.querySelector('.block-btn').addEventListener('click', e => { 
                                e.stopPropagation(); 
                                if(confirm(`Block ${profile.name}?`)) 
                                    db.ref(`/blocked/${currentUser.uid}/${profile.uid}`).set(true); 
                            });
                            itemEl.querySelector('.delete-chat-btn').addEventListener('click', e => { 
                                e.stopPropagation(); 
                                handleDeleteChat(profile); 
                            });
                            listEl.appendChild(itemEl);
                        }
                    });
                });
            });
        }

        function listenForFriendRequests() {
            const ref = db.ref(`/requests/${currentUser.uid}`);
            activeListeners.requests = ref;
            ref.on('value', snap => {
                const listEl = document.getElementById('notification-list');
                listEl.innerHTML = '';
                
                if (!snap.exists()) {
                    listEl.innerHTML = '<p>No new friend requests.</p>';
                    return;
                }
                
                snap.forEach(child => {
                    const senderUid = child.key;
                    fetchUserProfile(senderUid).then(profile => {
                        if (profile) {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'list-item';
                            itemEl.innerHTML = `
                                <div class="list-item-main">
                                    <div class="item-emoji">${profile.emoji}</div>
                                    <div class="item-info">
                                        <div class="item-name">${profile.name}</div>
                                        <div class="item-detail">Wants to be your friend</div>
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <button class="accept-friend" data-uid="${senderUid}">Accept</button>
                                    <button class="reject-friend reject-btn" data-uid="${senderUid}">Reject</button>
                                </div>`;
                            itemEl.querySelector('.accept-friend').addEventListener('click', e => 
                                handleFriendRequest(e.target.dataset.uid, true));
                            itemEl.querySelector('.reject-friend').addEventListener('click', e => 
                                handleFriendRequest(e.target.dataset.uid, false));
                            listEl.appendChild(itemEl);
                        }
                    });
                });
            });
        }

        function listenForNotifications() {
            // Remove any existing listener
            if (activeListeners.notifications) {
                activeListeners.notifications.off();
            }

            const ref = db.ref(`/notifications/${currentUser.uid}`);
            activeListeners.notifications = ref;
            
            ref.on('value', snap => {
                const badgeEl = document.querySelector('#nav-notifications .badge');
                if(badgeEl) badgeEl.remove();

                if (snap.exists()) {
                    const count = Object.keys(snap.val()).length;
                    if(count > 0) {
                        const badge = document.createElement('span');
                        badge.className = 'badge';
                        badge.textContent = count;
                        document.getElementById('nav-notifications').appendChild(badge);
                    }
                }
            });
        }

        function listenForCallLogs() { 
            const ref = db.ref(`/callLogs/${currentUser.uid}`).limitToLast(20); 
            activeListeners.callLogs = ref; 
            ref.on('value', snap => { 
                const listEl = document.getElementById('call-log-list'); 
                listEl.innerHTML = ''; 
                
                if (!snap.exists()) { 
                    listEl.innerHTML = '<p>No recent calls.</p>'; 
                    return; 
                } 
                
                const logs = []; 
                snap.forEach(c => logs.push(c.val())); 
                logs.reverse().forEach(log => { 
                    const el = document.createElement('div'); 
                    el.className = 'list-item'; 
                    el.innerHTML = `
                        <div class="item-emoji">${log.partner.emoji}</div>
                        <div class="item-info">
                            <div class="item-name">${log.partner.name} (${log.type} call)</div>
                            <div class="item-detail">${log.status} - ${new Date(log.timestamp).toLocaleString()}</div>
                        </div>`;
                    listEl.appendChild(el); 
                }); 
            }); 
        }

        function listenForUnreadMessages() { 
            const ref = db.ref(`/unreadCounts/${currentUser.uid}`); 
            activeListeners.unread = ref; 
            ref.on('value', snap => { 
                let total = 0; 
                snap.forEach(c => total += c.val()); 
                const badge = document.querySelector('#nav-home .badge'); 
                if (total > 0) { 
                    if (!badge) { 
                        const b = document.createElement('span'); 
                        b.className = 'badge'; 
                        document.getElementById('nav-home').appendChild(b); 
                    } 
                    document.querySelector('#nav-home .badge').textContent = total; 
                } else if(badge) { 
                    badge.remove(); 
                } 
            }); 
        }

        // --- MESSAGING ---
        function getChatId(uid1, uid2) { 
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`; 
        }

        async function handleSendMessage() { 
            const input = document.getElementById('chat-input'), 
                  text = input.value.trim(); 
            
            if (text && currentChatId && currentChatPartner) { 
                if (blockedUsers[currentChatPartner.uid]) 
                    return alert(`You have blocked ${currentChatPartner.name}.`); 
                
                await db.ref(`/messages/${currentChatId}`).push({ 
                    text, 
                    senderId: currentUser.uid, 
                    timestamp: firebase.database.ServerValue.TIMESTAMP 
                }); 
                
                await db.ref(`/unreadCounts/${currentChatPartner.uid}/${currentChatId}`).transaction(c => (c || 0) + 1); 
                input.value = ''; 
            } 
        }

        function loadChatMessages(chatId) { 
            const messagesEl = document.getElementById('chat-messages'); 
            messagesEl.innerHTML = ''; 
            const ref = db.ref(`/messages/${chatId}`).limitToLast(50); 
            
            if(activeListeners[chatId]) { 
                activeListeners[chatId].off(); 
            } 
            
            activeListeners[chatId] = ref; 
            ref.on('child_added', snap => { 
                const msg = snap.val(), 
                      el = document.createElement('div'); 
                el.classList.add('message-bubble', msg.senderId === currentUser.uid ? 'sent' : 'received'); 
                el.textContent = msg.text; 
                messagesEl.appendChild(el); 
                messagesEl.scrollTop = messagesEl.scrollHeight; 
            }); 
        }

        async function handleDeleteChat(partner) { 
            if (confirm(`Delete all messages with ${partner.name}? This cannot be undone.`)) { 
                const chatId = getChatId(currentUser.uid, partner.uid); 
                await db.ref(`/messages/${chatId}`).remove(); 
                await db.ref(`/unreadCounts/${currentUser.uid}/${chatId}`).remove(); 
                alert(`Chat history with ${partner.name} has been deleted.`); 
            } 
        }

        // --- WEBRTC CALLING ---
        function listenForIncomingCalls() { 
            const ref = db.ref(`/calls/${currentUser.uid}`); 
            activeListeners.calls = ref; 
            ref.on('value', async snap => { 
                if (snap.exists()) { 
                    incomingCallData = snap.val(); 
                    
                    if (blockedUsers[incomingCallData.callerId]) 
                        return db.ref(`/calls/${currentUser.uid}`).remove(); 
                    
                    const callerProfile = await fetchUserProfile(incomingCallData.callerId); 
                    if (callerProfile) { 
                        document.getElementById('incoming-caller-name').textContent = callerProfile.name; 
                        document.getElementById('incoming-caller-emoji').textContent = callerProfile.emoji; 
                        document.getElementById('incoming-call-type').textContent = `Incoming ${incomingCallData.type} call`; 
                        document.getElementById('incoming-call-modal').style.display = 'flex'; 
                        ringtone.play().catch(e => console.warn("Ringtone blocked by browser autoplay policy.")); 
                    } 
                } else { 
                    if (document.getElementById('incoming-call-modal').style.display === 'flex') { 
                        document.getElementById('incoming-call-modal').style.display = 'none'; 
                        ringtone.pause(); 
                        ringtone.currentTime = 0; 
                    } 
                } 
            }); 
        }

        async function initiateCall(partnerUid, type) { 
            if (blockedUsers[partnerUid]) { 
                return alert('You have blocked this user.'); 
            } 
            
            try {
                peerConnection = new RTCPeerConnection(rtcConfig); 
                localStream = await navigator.mediaDevices.getUserMedia(
                    type === 'video' ? { video: true, audio: true } : { audio: true }
                ); 
                
                if(type === 'video') { 
                    document.getElementById('local-video').srcObject = localStream; 
                } 
                
                localStream.getTracks().forEach(track => 
                    peerConnection.addTrack(track, localStream)); 
                
                peerConnection.onicecandidate = e => { 
                    if(e.candidate) 
                        db.ref(`/calls/${partnerUid}/iceCandidates/caller`).push(e.candidate.toJSON()); 
                }; 
                
                peerConnection.ontrack = e => { 
                    document.getElementById('remote-video').srcObject = e.streams[0]; 
                }; 
                
                const offer = await peerConnection.createOffer(); 
                await peerConnection.setLocalDescription(offer); 
                
                await db.ref(`/calls/${partnerUid}`).set({ 
                    callerId: currentUser.uid, 
                    type, 
                    offer: { type: offer.type, sdp: offer.sdp } 
                }); 
                
                const partnerProfile = await fetchUserProfile(partnerUid); 
                showCallUI(partnerProfile, type, 'Calling...'); 
                
                const answerRef = db.ref(`/calls/${partnerUid}/answer`); 
                activeListeners.callAnswer = answerRef; 
                answerRef.on('value', async s => { 
                    if (s.exists() && peerConnection && peerConnection.signalingState !== 'closed') { 
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(s.val())); 
                        document.getElementById('call-view-status').textContent = 'Connected'; 
                        listenForIceCandidates(partnerUid, 'callee'); 
                        answerRef.off(); 
                    } 
                }); 
            } catch (error) {
                console.error("Call initiation failed:", error);
                alert("Failed to start call. Please try again.");
                endCall();
            }
        }

        async function handleAcceptCall() { 
            ringtone.pause(); 
            ringtone.currentTime = 0; 
            document.getElementById('incoming-call-modal').style.display = 'none'; 
            
            try {
                peerConnection = new RTCPeerConnection(rtcConfig); 
                localStream = await navigator.mediaDevices.getUserMedia(
                    incomingCallData.type === 'video' ? { video: true, audio: true } : { audio: true }
                ); 
                
                if(incomingCallData.type === 'video') { 
                    document.getElementById('local-video').srcObject = localStream; 
                } 
                
                localStream.getTracks().forEach(track => 
                    peerConnection.addTrack(track, localStream)); 
                
                peerConnection.onicecandidate = e => { 
                    if(e.candidate) 
                        db.ref(`/calls/${currentUser.uid}/iceCandidates/callee`).push(e.candidate.toJSON()); 
                }; 
                
                peerConnection.ontrack = e => { 
                    document.getElementById('remote-video').srcObject = e.streams[0]; 
                }; 
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(incomingCallData.offer)); 
                const answer = await peerConnection.createAnswer(); 
                await peerConnection.setLocalDescription(answer); 
                
                await db.ref(`/calls/${currentUser.uid}/answer`).set({ 
                    type: answer.type, 
                    sdp: answer.sdp 
                }); 
                
                const callerProfile = await fetchUserProfile(incomingCallData.callerId); 
                showCallUI(callerProfile, incomingCallData.type, 'Connected'); 
                listenForIceCandidates(currentUser.uid, 'caller'); 
            } catch (error) {
                console.error("Call acceptance failed:", error);
                alert("Failed to accept call. Please try again.");
                endCall();
            }
        }

        function handleRejectCall() { 
            ringtone.pause(); 
            ringtone.currentTime = 0; 
            document.getElementById('incoming-call-modal').style.display = 'none'; 
            logCall(incomingCallData.callerId, currentUser.uid, incomingCallData.type, 'rejected'); 
            db.ref(`/calls/${currentUser.uid}`).remove(); 
            incomingCallData = null; 
        }

        function listenForIceCandidates(uid, role) { 
            const ref = db.ref(`/calls/${uid}/iceCandidates/${role}`); 
            activeListeners.iceCandidates = ref; 
            ref.on('child_added', s => { 
                if (s.exists() && peerConnection && peerConnection.signalingState !== 'closed') 
                    peerConnection.addIceCandidate(new RTCIceCandidate(s.val()))
                        .catch(e => console.error("ICE Error:", e)); 
            }); 
        }

        function showCallUI(partner, type, status) { 
            document.getElementById('call-view-emoji').textContent = partner.emoji; 
            document.getElementById('call-view-name').textContent = partner.name; 
            document.getElementById('call-view-status').textContent = status; 
            document.getElementById('local-video').style.display = type === 'video' ? 'block' : 'none'; 
            document.getElementById('remote-video').style.display = type === 'video' ? 'block' : 'none'; 
            document.querySelector('.call-info').style.position = type === 'video' ? 'absolute' : 'static'; 
            document.querySelector('.call-info').style.transform = type === 'video' ? 'translateX(-50%)' : 'none'; 
            document.getElementById('call-view').style.display = 'flex'; 
        }

        async function endCall() { 
            if (peerConnection) { 
                peerConnection.close(); 
                peerConnection = null; 
            } 
            
            if (localStream) { 
                localStream.getTracks().forEach(track => track.stop()); 
                localStream = null; 
            } 
            
            document.getElementById('call-view').style.display = 'none'; 
            
            const callerSnap = await db.ref('/calls').orderByChild('callerId').equalTo(currentUser.uid).once('value'); 
            const calleeSnap = await db.ref('/calls').orderByChild('calleeId').equalTo(currentUser.uid).once('value'); 
            
            let callKey, callData, calleeId; 
            if (callerSnap.exists()) { 
                callKey = Object.keys(callerSnap.val())[0]; 
                callData = callerSnap.val()[callKey]; 
                calleeId = callKey; 
            } else if (calleeSnap.exists()) { 
                callKey = Object.keys(calleeSnap.val())[0]; 
                callData = calleeSnap.val()[callKey]; 
                calleeId = callKey; 
            } 
            
            if (callKey && callData) { 
                logCall(callData.callerId, calleeId, callData.type, 'completed'); 
                db.ref(`/calls/${callKey}`).remove(); 
            } 
            
            if(activeListeners.callAnswer) activeListeners.callAnswer.off(); 
            if(activeListeners.iceCandidates) activeListeners.iceCandidates.off(); 
        }

        async function logCall(callerId, calleeId, type, status) { 
            const [caller, callee] = await Promise.all([
                fetchUserProfile(callerId), 
                fetchUserProfile(calleeId)
            ]); 
            
            const log = { 
                type, 
                status, 
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            }; 
            
            if (caller && callee) { 
                db.ref(`/callLogs/${callerId}`).push({ 
                    ...log, 
                    partner: { 
                        uid: calleeId, 
                        name: callee.name, 
                        emoji: callee.emoji 
                    } 
                });
                
                db.ref(`/callLogs/${calleeId}`).push({ 
                    ...log, 
                    partner: { 
                        uid: callerId, 
                        name: caller.name, 
                        emoji: caller.emoji 
                    } 
                }); 
            } 
        }

        // --- UTILITY FUNCTIONS ---
        function toggleTheme() { 
            document.body.classList.toggle('light-theme'); 
            localStorage.setItem('theme', 
                document.body.classList.contains('light-theme') ? 'light' : 'dark'); 
        }

        function makeElementDraggable(elmnt) { 
            let p1=0,p2=0,p3=0,p4=0; 
            elmnt.onmousedown=e=>{e.preventDefault();p3=e.clientX;p4=e.clientY;document.onmouseup=closeDrag;document.onmousemove=elementDrag;}; 
            function elementDrag(e){e.preventDefault();p1=p3-e.clientX;p2=p4-e.clientY;p3=e.clientX;p4=e.clientY;elmnt.style.top=`${elmnt.offsetTop-p2}px`;elmnt.style.left=`${elmnt.offsetLeft-p1}px`;} 
            function closeDrag(){document.onmouseup=null;document.onmousemove=null;} 
        }
    </script>
</body>
</html>
