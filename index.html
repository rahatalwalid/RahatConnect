<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RahatConnect</title>
    
    <!-- Google Font: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">

    <!-- Firebase v8 SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --bg-color: #0f0f2d;
            --text-color: #ffffff;
            --primary-color: #e94560; /* Neon Pink */
            --secondary-color: #3a8bfd; /* Neon Blue */
            --container-bg: rgba(255, 255, 255, 0.05);
            --sent-bubble-bg: #3a8bfd;
            --received-bubble-bg: #33335a;
        }

        body.light-theme {
            --bg-color: #f0f2f5;
            --text-color: #0f0f2d;
            --container-bg: #ffffff;
            --sent-bubble-bg: #3a8bfd;
            --received-bubble-bg: #e4e6eb;
        }

        /* --- GLOBAL STYLES --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        #app-container {
            width: 100%;
            max-width: 450px;
            height: 100vh;
            max-height: 900px;
            background-color: var(--bg-color);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* --- AUTH VIEW --- */
        .auth-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            height: 100%;
        }

        .auth-view h1 {
            font-size: 36px;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color);
            margin-bottom: 40px;
        }
        
        .auth-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .auth-form input {
            border-radius: 25px;
            border: 2px solid var(--secondary-color);
            background: transparent;
            color: var(--text-color);
            padding: 12px 20px;
            max-width: 350px;
            width: 100%;
            font-size: 16px;
        }

        .auth-form input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        body.light-theme .auth-form input::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }

        .auth-form button {
            border-radius: 50px;
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            border: none;
            padding: 12px 20px;
            width: 100%;
            max-width: 350px;
            cursor: pointer;
            transition: box-shadow 0.3s ease, transform 0.2s ease;
            font-size: 16px;
        }
        .auth-form button:disabled {
            background-color: #888;
            cursor: not-allowed;
        }

        .auth-form button:hover:not(:disabled) {
            box-shadow: 0 0 15px var(--primary-color), 0 0 25px var(--primary-color);
            transform: translateY(-2px);
        }
        
        .form-switch {
            color: var(--text-color);
            font-size: 13px;
            margin-top: 20px;
        }

        .form-switch a {
            color: var(--primary-color);
            text-decoration: underline;
            font-weight: bold;
            cursor: pointer;
        }
        
        .error-message {
            color: #ff4d4d;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            min-height: 20px;
        }

        /* --- MAIN APP VIEW --- */
        #main-app-view {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        header, footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--container-bg);
            flex-shrink: 0;
        }
        
        header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        header h1 {
            font-size: 20px;
            color: var(--primary-color);
            text-shadow: 0 0 5px var(--primary-color);
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 16px;
            padding: 5px 10px;
            position: relative;
        }
        
        .badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            width: 18px;
            height: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            transform: translate(50%, -50%);
        }

        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .list-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: var(--container-bg);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .list-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .item-emoji {
            font-size: 24px;
            margin-right: 15px;
        }

        .item-info {
            flex-grow: 1;
        }

        .item-name {
            font-weight: bold;
        }
        
        .item-detail {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
        }
        
        body.light-theme .item-detail {
            color: rgba(0,0,0,0.6);
        }

        .item-actions button {
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-left: 5px;
            cursor: pointer;
        }

        .item-actions button.reject {
            background: var(--primary-color);
        }

        /* --- CHAT PAGE --- */
        #chat-page {
            display: none; /* Changed from 'flex' to 'none' by default */
            flex-direction: column;
            height: 100%;
        }

        #chat-header {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: var(--container-bg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        #chat-header button {
            margin-right: 10px;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .sent {
            background-color: var(--sent-bubble-bg);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .received {
            background-color: var(--received-bubble-bg);
            color: var(--text-color);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        #chat-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #chat-input {
            flex-grow: 1;
            background: var(--container-bg);
            border: 1px solid var(--secondary-color);
            color: var(--text-color);
            border-radius: 20px;
            padding: 10px 15px;
        }

        #send-message-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            margin-left: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* Changed from 'flex' to 'none' */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-color);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--secondary-color);
            box-shadow: 0 0 20px var(--secondary-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-content h2 {
            text-align: center;
            color: var(--primary-color);
        }

        .modal-content input, .modal-content button {
            width: 100%;
        }

        .modal-content input {
            border-radius: 25px;
            border: 2px solid var(--secondary-color);
            background: transparent;
            color: var(--text-color);
            padding: 12px 20px;
            font-size: 16px;
        }

        .modal-content button {
            border-radius: 50px;
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
        }
        
        .modal-content .button-group {
            display: flex;
            gap: 10px;
        }

        .modal-content button.secondary {
            background-color: #555;
        }
        .modal-content button:disabled {
            background-color: #888;
            cursor: not-allowed;
        }


        /* --- CALL UI --- */
        #call-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #remote-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 25%;
            max-width: 150px;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            cursor: move;
            z-index: 2001;
        }

        .call-info {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2002;
            background-color: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
        }
        
        .call-info .caller-emoji {
            font-size: 40px;
        }

        .call-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2002;
            display: flex;
            gap: 20px;
        }

        .call-controls button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        #end-call-btn {
            background-color: var(--primary-color);
            color: white;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- AUTHENTICATION VIEW -->
        <div id="auth-view" class="auth-view">
            <h1 id="app-title">RahatConnect</h1>
            
            <!-- Login Form -->
            <div id="login-form" class="auth-form">
                <input type="email" id="login-email" placeholder="Email">
                <input type="password" id="login-password" placeholder="Password">
                <button id="login-btn">Log In</button>
                <p class="error-message" id="login-error"></p>
                <p class="form-switch">Don't have an account? <a id="show-signup">Sign up</a></p>
            </div>

            <!-- Signup Form -->
            <div id="signup-form" class="auth-form" style="display: none;">
                <input type="email" id="signup-email" placeholder="Email">
                <input type="password" id="signup-password" placeholder="Password">
                <button id="signup-btn">Sign Up</button>
                <p class="error-message" id="signup-error"></p>
                <p class="form-switch">Already have an account? <a id="show-login">Log in</a></p>
            </div>
        </div>

        <!-- MAIN APP VIEW -->
        <div id="main-app-view" style="display: none;">
            <header>
                <button id="menu-btn" class="nav-btn">Menu</button>
                <h1>RahatConnect</h1>
                <button id="add-friend-btn" class="nav-btn">Add Friend</button>
            </header>

            <main id="content-pages">
                <!-- Home Page (Contact List) -->
                <div id="home-page" class="page active">
                    <div id="contact-list"></div>
                </div>

                <!-- Notifications Page -->
                <div id="notifications-page" class="page">
                    <h2>Notifications</h2>
                    <div id="notification-list"></div>
                </div>

                <!-- Calls Page (Call Logs) -->
                <div id="calls-page" class="page">
                    <h2>Call Logs</h2>
                    <div id="call-log-list"></div>
                </div>
            </main>
            
            <!-- Chat Page (dynamically populated) -->
            <div id="chat-page" class="page">
                <div id="chat-header">
                    <button id="back-to-home-btn" class="nav-btn">Back</button>
                    <div class="item-emoji" id="chat-header-emoji"></div>
                    <div class="item-info">
                        <div class="item-name" id="chat-header-name"></div>
                    </div>
                </div>
                <div id="chat-messages"></div>
                <div id="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Type a message...">
                    <button id="send-message-btn">Send</button>
                </div>
            </div>

            <footer>
                <button id="nav-home" class="nav-btn">Home</button>
                <button id="nav-notifications" class="nav-btn">Notifications</button>
                <button id="nav-calls" class="nav-btn">Calls</button>
            </footer>
        </div>
    </div>

    <!-- MODALS & OVERLAYS -->
    
    <!-- Profile Setup Modal -->
    <div id="profile-setup-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Setup Your Profile</h2>
            <input type="text" id="profile-name-input" placeholder="Your Name">
            <input type="text" id="profile-emoji-input" placeholder="Your Emoji (max 2)" maxlength="2">
            <button id="save-profile-btn">Save Profile</button>
        </div>
    </div>

    <!-- Incoming Call Modal -->
    <div id="incoming-call-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="incoming-call-type">Incoming Call</h2>
            <div style="text-align: center;">
                <div id="incoming-caller-emoji" style="font-size: 48px;"></div>
                <h3 id="incoming-caller-name"></h3>
            </div>
            <div class="button-group">
                <button id="reject-call-btn" class="secondary">Reject</button>
                <button id="accept-call-btn">Accept</button>
            </div>
        </div>
    </div>
    
    <!-- Menu Modal -->
    <div id="menu-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Menu</h2>
            <button id="menu-profile-btn">My Profile</button>
            <button id="menu-blocked-btn">Blocked Users</button>
            <button id="menu-theme-btn">Toggle Theme</button>
            <button id="menu-logout-btn" class="secondary">Logout</button>
            <button id="menu-close-btn" class="secondary">Close</button>
        </div>
    </div>

    <!-- My Profile Modal -->
     <div id="my-profile-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>My Profile</h2>
            <p><strong>Name:</strong> <span id="profile-view-name"></span></p>
            <p><strong>Emoji:</strong> <span id="profile-view-emoji"></span></p>
            <p><strong>ID:</strong> <span id="profile-view-id"></span></p>
            <input type="text" id="profile-edit-name" style="display:none;">
            <input type="text" id="profile-edit-emoji" style="display:none;" maxlength="2">
            <button id="profile-edit-btn">Edit</button>
            <button id="profile-save-changes-btn" style="display:none;">Save Changes</button>
            <button id="profile-close-btn" class="secondary">Close</button>
        </div>
    </div>

    <!-- CALL VIEW -->
    <div id="call-view">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>

        <div class="call-info">
            <div class="caller-emoji" id="call-view-emoji"></div>
            <h3 id="call-view-name"></h3>
            <p id="call-view-status">Connecting...</p>
        </div>

        <div class="call-controls">
            <button id="end-call-btn">End</button>
        </div>
    </div>
    
    <!-- RINGTONE -->
    <audio id="ringtone" src="https://github.com/rahatalwalid/RahatConnect-Sound/raw/refs/heads/main/incoming.wav" loop></audio>
    
<script>
// --- FIREBASE CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyCyi55rVrsBtF9HpqMWz2a4H4ggwSkJ6z4",
    authDomain: "rahatconnect-e9755.firebaseapp.com",
    databaseURL: "https://rahatconnect-e9755-default-rtdb.firebaseio.com",
    projectId: "rahatconnect-e9755",
    storageBucket: "rahatconnect-e9755.appspot.com",
    messagingSenderId: "326989187761",
    appId: "1:326989187761:web:b2800fdbadb32b2a3af090"
};

// --- INITIALIZE FIREBASE v8 ---
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// --- GLOBAL STATE ---
let currentUser = null;
let currentUserProfile = null;
let currentChatPartner = null;
let currentChatId = null;
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let incomingCallData = null;
let activeListeners = {}; 

const rtcConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};


// --- DOM ELEMENTS ---
const authView = document.getElementById('auth-view');
const mainAppView = document.getElementById('main-app-view');
const loginForm = document.getElementById('login-form');
const signupForm = document.getElementById('signup-form');
const showSignupLink = document.getElementById('show-signup');
const showLoginLink = document.getElementById('show-login');

// --- APP INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    // Theme setup
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
    }
    
    // Auth state listener
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            try {
                const profile = await fetchUserProfile(user.uid);
                
                // Check if profile exists and is valid
                if (profile && profile.name) {
                    currentUserProfile = profile;
                    initializeAppUI();
                    authView.style.display = 'none';
                    mainAppView.style.display = 'flex';
                } else {
                    // This handles both new signups and existing users with missing profiles
                    authView.style.display = 'none';
                    mainAppView.style.display = 'none';
                    document.getElementById('profile-setup-modal').style.display = 'flex';
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                // Fallback to auth view on error
                auth.signOut(); 
            }
        } else {
            currentUser = null;
            currentUserProfile = null;
            authView.style.display = 'flex';
            mainAppView.style.display = 'none';
            cleanupListeners();
        }
    });

    // Event Listeners
    setupEventListeners();
});

// --- UI & VIEW MANAGEMENT ---
function showPage(pageId) {
    document.querySelectorAll('#content-pages .page').forEach(page => page.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    
    if (pageId === 'chat-page') {
        document.getElementById('content-pages').style.display = 'none';
        document.getElementById('chat-page').style.display = 'flex';
    } else {
        document.getElementById('content-pages').style.display = 'block';
        document.getElementById('chat-page').style.display = 'none';
    }
}


function showChatPage(partnerData) {
    currentChatPartner = partnerData;
    currentChatId = getChatId(currentUser.uid, partnerData.uid);

    showPage('chat-page');
    
    document.getElementById('chat-header-emoji').textContent = partnerData.emoji;
    document.getElementById('chat-header-name').textContent = partnerData.name;
    
    loadChatMessages(currentChatId);
    db.ref(`/unreadCounts/${currentUser.uid}/${currentChatId}`).set(0);
}


// --- EVENT LISTENERS SETUP ---
function setupEventListeners() {
    // Auth form switching
    showSignupLink.addEventListener('click', () => {
        loginForm.style.display = 'none';
        signupForm.style.display = 'block';
    });
    showLoginLink.addEventListener('click', () => {
        signupForm.style.display = 'none';
        loginForm.style.display = 'block';
    });

    // Auth actions
    document.getElementById('signup-btn').addEventListener('click', handleSignup);
    document.getElementById('login-btn').addEventListener('click', handleLogin);
    
    // Profile setup
    document.getElementById('save-profile-btn').addEventListener('click', handleProfileSetup);

    // Navigation
    document.getElementById('nav-home').addEventListener('click', () => showPage('home-page'));
    document.getElementById('nav-notifications').addEventListener('click', () => showPage('notifications-page'));
    document.getElementById('nav-calls').addEventListener('click', () => showPage('calls-page'));
    document.getElementById('back-to-home-btn').addEventListener('click', () => {
        showPage('home-page');
        if (currentChatId && activeListeners[currentChatId]) {
            activeListeners[currentChatId].off();
            delete activeListeners[currentChatId];
        }
        currentChatId = null;
        currentChatPartner = null;
    });

    // Header buttons
    document.getElementById('add-friend-btn').addEventListener('click', handleAddFriend);
    document.getElementById('menu-btn').addEventListener('click', () => document.getElementById('menu-modal').style.display = 'flex');

    // Menu Modal
    document.getElementById('menu-close-btn').addEventListener('click', () => document.getElementById('menu-modal').style.display = 'none');
    document.getElementById('menu-logout-btn').addEventListener('click', () => auth.signOut());
    document.getElementById('menu-theme-btn').addEventListener('click', toggleTheme);
    document.getElementById('menu-profile-btn').addEventListener('click', showMyProfile);
    // document.getElementById('menu-blocked-btn').addEventListener('click', showBlockedUsers); // Placeholder for blocked users UI

    // Profile Modal
    document.getElementById('profile-close-btn').addEventListener('click', () => document.getElementById('my-profile-modal').style.display = 'none');
    document.getElementById('profile-edit-btn').addEventListener('click', toggleProfileEdit);
    document.getElementById('profile-save-changes-btn').addEventListener('click', saveProfileChanges);

    // Chat
    document.getElementById('send-message-btn').addEventListener('click', handleSendMessage);
    document.getElementById('chat-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSendMessage();
    });
    
    // Calling
    document.getElementById('accept-call-btn').addEventListener('click', handleAcceptCall);
    document.getElementById('reject-call-btn').addEventListener('click', handleRejectCall);
    document.getElementById('end-call-btn').addEventListener('click', endCall);
    makeElementDraggable(document.getElementById('local-video'));
}

// --- AUTHENTICATION HANDLERS ---
function handleSignup() {
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    const errorEl = document.getElementById('signup-error');
    errorEl.textContent = '';

    auth.createUserWithEmailAndPassword(email, password)
        .catch(error => {
            errorEl.textContent = error.message;
        });
}

function handleLogin() {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const errorEl = document.getElementById('login-error');
    errorEl.textContent = '';
    
    auth.signInWithEmailAndPassword(email, password)
        .catch(error => {
            errorEl.textContent = error.message;
        });
}


// --- PROFILE & USER DATA ---
async function fetchUserProfile(uid) {
    const snapshot = await db.ref(`/users/${uid}`).once('value');
    return snapshot.val();
}

async function handleProfileSetup() {
    const name = document.getElementById('profile-name-input').value.trim();
    const emoji = document.getElementById('profile-emoji-input').value.trim();
    const saveBtn = document.getElementById('save-profile-btn');
    
    if (!name || !emoji) {
        alert('Please fill out both name and emoji.');
        return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
    
    try {
        const connectId = await generateUniqueConnectId();
        
        const profileData = {
            name,
            emoji,
            connectId,
            uid: currentUser.uid,
        };

        await db.ref(`/users/${currentUser.uid}`).set(profileData);
        currentUserProfile = profileData;
        
        document.getElementById('profile-setup-modal').style.display = 'none';
        initializeAppUI();
        authView.style.display = 'none';
        mainAppView.style.display = 'flex';

    } catch(error) {
        console.error("Error saving profile:", error);
        alert("Could not save profile. Please try again.");
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Profile';
    }
}

async function generateUniqueConnectId() {
    let isUnique = false;
    let newId;
    while (!isUnique) {
        const randomNum = Math.floor(1000 + Math.random() * 9000);
        newId = `Connect-${randomNum}`;
        const snapshot = await db.ref('users').orderByChild('connectId').equalTo(newId).once('value');
        if (!snapshot.exists()) {
            isUnique = true;
        }
    }
    return newId;
}

function showMyProfile() {
    document.getElementById('menu-modal').style.display = 'none';
    document.getElementById('my-profile-modal').style.display = 'flex';
    
    document.getElementById('profile-view-name').textContent = currentUserProfile.name;
    document.getElementById('profile-view-emoji').textContent = currentUserProfile.emoji;
    document.getElementById('profile-view-id').textContent = currentUserProfile.connectId;
    
    // Reset edit state
    document.getElementById('profile-edit-name').style.display = 'none';
    document.getElementById('profile-edit-emoji').style.display = 'none';
    document.getElementById('profile-save-changes-btn').style.display = 'none';
    document.getElementById('profile-edit-btn').style.display = 'block';
}

function toggleProfileEdit() {
    document.getElementById('profile-edit-btn').style.display = 'none';
    document.getElementById('profile-save-changes-btn').style.display = 'block';

    const nameInput = document.getElementById('profile-edit-name');
    const emojiInput = document.getElementById('profile-edit-emoji');

    nameInput.value = currentUserProfile.name;
    emojiInput.value = currentUserProfile.emoji;

    nameInput.style.display = 'block';
    emojiInput.style.display = 'block';
}

async function saveProfileChanges() {
    const newName = document.getElementById('profile-edit-name').value.trim();
    const newEmoji = document.getElementById('profile-edit-emoji').value.trim();

    if (!newName || !newEmoji) {
        alert('Name and emoji cannot be empty.');
        return;
    }

    await db.ref(`/users/${currentUser.uid}`).update({ name: newName, emoji: newEmoji });
    
    currentUserProfile.name = newName;
    currentUserProfile.emoji = newEmoji;

    showMyProfile(); // Refresh and reset view
}


// --- MAIN APP INITIALIZATION & LISTENERS ---
function initializeAppUI() {
    cleanupListeners();
    showPage('home-page');
    
    listenForContacts();
    listenForNotifications();
    listenForCallLogs();
    listenForIncomingCalls();
    listenForUnreadMessages();
}

function cleanupListeners() {
    Object.values(activeListeners).forEach(ref => {
        if (ref && typeof ref.off === 'function') {
            ref.off();
        }
    });
    activeListeners = {};
}

function listenForContacts() {
    const contactsRef = db.ref(`/contacts/${currentUser.uid}`);
    activeListeners.contacts = contactsRef;
    
    contactsRef.on('value', snapshot => {
        const contactListEl = document.getElementById('contact-list');
        contactListEl.innerHTML = '';
        if (!snapshot.exists()) {
            contactListEl.innerHTML = '<p>Add friends to start chatting!</p>';
            return;
        }
        snapshot.forEach(childSnapshot => {
            const contactData = childSnapshot.val();
            fetchUserProfile(contactData.uid).then(profile => {
                if (profile) {
                    const contactEl = document.createElement('div');
                    contactEl.className = 'list-item';
                    contactEl.innerHTML = `
                        <div class="item-emoji">${profile.emoji}</div>
                        <div class="item-info">
                            <div class="item-name">${profile.name}</div>
                            <div class="item-detail">${profile.connectId}</div>
                        </div>
                        <div class="item-actions">
                            <button class="call-btn" data-uid="${profile.uid}" data-type="voice">Call</button>
                            <button class="call-btn" data-uid="${profile.uid}" data-type="video">Video</button>
                        </div>
                    `;
                    contactEl.querySelector('.item-info').addEventListener('click', () => showChatPage(profile));
                    contactEl.querySelectorAll('.call-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            initiateCall(e.target.dataset.uid, e.target.dataset.type);
                        });
                    });
                    contactListEl.appendChild(contactEl);
                }
            });
        });
    });
}

function listenForNotifications() {
    const notificationsRef = db.ref(`/notifications/${currentUser.uid}`);
    activeListeners.notifications = notificationsRef;

    notificationsRef.on('value', snapshot => {
        const listEl = document.getElementById('notification-list');
        listEl.innerHTML = '';
        const badgeEl = document.querySelector('#nav-notifications .badge');

        if (!snapshot.exists()) {
            listEl.innerHTML = '<p>No new notifications.</p>';
            if (badgeEl) badgeEl.remove();
            return;
        }

        if (!badgeEl) {
            const newBadge = document.createElement('span');
            newBadge.className = 'badge';
            document.getElementById('nav-notifications').appendChild(newBadge);
        }
        document.querySelector('#nav-notifications .badge').textContent = snapshot.numChildren();
        
        snapshot.forEach(childSnapshot => {
            const notif = childSnapshot.val();
            const notifKey = childSnapshot.key;
            if (notif.type === 'friend_request') {
                fetchUserProfile(notif.from).then(profile => {
                   const itemEl = document.createElement('div');
                   itemEl.className = 'list-item';
                   itemEl.innerHTML = `
                        <div class="item-emoji">${profile.emoji}</div>
                        <div class="item-info">
                            <div class="item-name">${profile.name}</div>
                            <div class="item-detail">Sent you a friend request</div>
                        </div>
                        <div class="item-actions">
                            <button class="accept-friend" data-key="${notifKey}" data-uid="${notif.from}">Accept</button>
                            <button class="reject-friend reject" data-key="${notifKey}" data-uid="${notif.from}">Reject</button>
                        </div>
                   `;
                   listEl.appendChild(itemEl);
                });
            }
        });
        
        // Add event listeners after rendering
        setTimeout(() => {
            document.querySelectorAll('.accept-friend').forEach(btn => btn.addEventListener('click', (e) => handleFriendRequest(e.target.dataset.uid, true, e.target.dataset.key)));
            document.querySelectorAll('.reject-friend').forEach(btn => btn.addEventListener('click', (e) => handleFriendRequest(e.target.dataset.uid, false, e.target.dataset.key)));
        }, 100);
    });
}

async function handleFriendRequest(senderUid, accepted, notifKey) {
    const myUid = currentUser.uid;

    await db.ref(`/notifications/${myUid}/${notifKey}`).remove();
    
    if (accepted) {
        const contactData = { uid: senderUid, addedAt: firebase.database.ServerValue.TIMESTAMP };
        await db.ref(`/contacts/${myUid}/${senderUid}`).set(contactData);
        
        const myContactData = { uid: myUid, addedAt: firebase.database.ServerValue.TIMESTAMP };
        await db.ref(`/contacts/${senderUid}/${myUid}`).set(myContactData);
    }
}

function listenForCallLogs() {
    const callLogsRef = db.ref(`/callLogs/${currentUser.uid}`).limitToLast(20);
    activeListeners.callLogs = callLogsRef;

    callLogsRef.on('value', snapshot => {
        const listEl = document.getElementById('call-log-list');
        listEl.innerHTML = '';
        if (!snapshot.exists()) {
            listEl.innerHTML = '<p>No recent calls.</p>';
            return;
        }
        
        const logs = [];
        snapshot.forEach(child => logs.push(child.val()));
        logs.reverse(); // Show most recent first

        logs.forEach(log => {
             const itemEl = document.createElement('div');
             itemEl.className = 'list-item';
             const date = new Date(log.timestamp).toLocaleString();
             itemEl.innerHTML = `
                <div class="item-emoji">${log.partner.emoji}</div>
                <div class="item-info">
                    <div class="item-name">${log.partner.name} (${log.type} call)</div>
                    <div class="item-detail">${log.status} - ${date}</div>
                </div>
             `;
             listEl.appendChild(itemEl);
        });
    });
}

function listenForUnreadMessages() {
    const unreadRef = db.ref(`/unreadCounts/${currentUser.uid}`);
    activeListeners.unread = unreadRef;
    
    unreadRef.on('value', snapshot => {
        let totalUnread = 0;
        snapshot.forEach(chatSnapshot => {
            totalUnread += chatSnapshot.val();
        });
        
        const badgeEl = document.querySelector('#nav-home .badge');
        if (totalUnread > 0) {
            if (!badgeEl) {
                const newBadge = document.createElement('span');
                newBadge.className = 'badge';
                document.getElementById('nav-home').appendChild(newBadge);
            }
            document.querySelector('#nav-home .badge').textContent = totalUnread;
        } else {
            if (badgeEl) badgeEl.remove();
        }
    });
}

// --- FRIEND SYSTEM ---
async function handleAddFriend() {
    const friendId = prompt('Enter the Connect-ID of the user you want to add:');
    if (!friendId) return;

    const usersRef = db.ref('users');
    const snapshot = await usersRef.orderByChild('connectId').equalTo(friendId.trim()).once('value');

    if (!snapshot.exists()) {
        alert('User not found.');
        return;
    }

    const recipientUid = Object.keys(snapshot.val())[0];
    if (recipientUid === currentUser.uid) {
        alert("You can't add yourself!");
        return;
    }

    // Check if already friends
    const contactCheck = await db.ref(`/contacts/${currentUser.uid}/${recipientUid}`).once('value');
    if (contactCheck.exists()) {
        alert("You are already friends with this user.");
        return;
    }

    // Send notification
    const notification = { type: 'friend_request', from: currentUser.uid, timestamp: firebase.database.ServerValue.TIMESTAMP };
    await db.ref(`/notifications/${recipientUid}`).push(notification);

    alert('Friend request sent!');
}


// --- REALTIME MESSAGING ---
function getChatId(uid1, uid2) {
    return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
}

function loadChatMessages(chatId) {
    const messagesEl = document.getElementById('chat-messages');
    messagesEl.innerHTML = '';
    
    const messagesRef = db.ref(`/messages/${chatId}`).limitToLast(50);
    activeListeners[chatId] = messagesRef;

    messagesRef.on('child_added', snapshot => {
        const message = snapshot.val();
        const messageEl = document.createElement('div');
        messageEl.classList.add('message-bubble');
        messageEl.classList.add(message.senderId === currentUser.uid ? 'sent' : 'received');
        messageEl.textContent = message.text;
        messagesEl.appendChild(messageEl);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    });
}

async function handleSendMessage() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();

    if (text && currentChatId && currentChatPartner) {
        const messageData = {
            text: text,
            senderId: currentUser.uid,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        await db.ref(`/messages/${currentChatId}`).push(messageData);
        
        // Increment unread count for the partner
        const unreadRef = db.ref(`/unreadCounts/${currentChatPartner.uid}/${currentChatId}`);
        await unreadRef.transaction(count => (count || 0) + 1);
        
        input.value = '';
    }
}

// --- WEBRTC CALLING ---
const ringtone = document.getElementById('ringtone');

function listenForIncomingCalls() {
    const callRef = db.ref(`/calls/${currentUser.uid}`);
    activeListeners.calls = callRef;

    callRef.on('value', async snapshot => {
        if (snapshot.exists()) {
            incomingCallData = snapshot.val();
            const callerProfile = await fetchUserProfile(incomingCallData.callerId);

            document.getElementById('incoming-caller-name').textContent = callerProfile.name;
            document.getElementById('incoming-caller-emoji').textContent = callerProfile.emoji;
            document.getElementById('incoming-call-type').textContent = `Incoming ${incomingCallData.type} call`;
            document.getElementById('incoming-call-modal').style.display = 'flex';
            ringtone.play();
        } else {
            // Call was cancelled or doesn't exist
            if (document.getElementById('incoming-call-modal').style.display === 'flex') {
                document.getElementById('incoming-call-modal').style.display = 'none';
                ringtone.pause();
                ringtone.currentTime = 0;
            }
        }
    });
}

async function initiateCall(partnerUid, type) {
    const callData = {
        callerId: currentUser.uid,
        calleeId: partnerUid,
        type: type,
        status: 'dialing',
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    peerConnection = new RTCPeerConnection(rtcConfig);
    
    if (type === 'video') {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('local-video').srcObject = localStream;
    } else {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    }

    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
    
    peerConnection.onicecandidate = event => {
        if (event.candidate) {
            db.ref(`/calls/${partnerUid}/iceCandidates/caller`).push(event.candidate.toJSON());
        }
    };
    
    peerConnection.ontrack = event => {
        remoteStream = event.streams[0];
        document.getElementById('remote-video').srcObject = remoteStream;
    };

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    
    callData.offer = { type: offer.type, sdp: offer.sdp };

    await db.ref(`/calls/${partnerUid}`).set(callData);
    
    const partnerProfile = await fetchUserProfile(partnerUid);
    showCallUI(partnerProfile, type, 'Calling...');
    
    // Listen for answer
    const answerRef = db.ref(`/calls/${partnerUid}/answer`);
    activeListeners.callAnswer = answerRef;
    answerRef.on('value', async snapshot => {
        if (snapshot.exists() && peerConnection.signalingState !== 'closed') {
            const answer = snapshot.val();
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            document.getElementById('call-view-status').textContent = 'Connected';
            
            listenForIceCandidates(partnerUid, 'callee');
            answerRef.off();
        }
    });
}

async function handleAcceptCall() {
    ringtone.pause();
    ringtone.currentTime = 0;
    document.getElementById('incoming-call-modal').style.display = 'none';

    peerConnection = new RTCPeerConnection(rtcConfig);

    if (incomingCallData.type === 'video') {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('local-video').srcObject = localStream;
    } else {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    }
    
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.onicecandidate = event => {
        if (event.candidate) {
            db.ref(`/calls/${currentUser.uid}/iceCandidates/callee`).push(event.candidate.toJSON());
        }
    };
    
    peerConnection.ontrack = event => {
        remoteStream = event.streams[0];
        document.getElementById('remote-video').srcObject = remoteStream;
    };
    
    await peerConnection.setRemoteDescription(new RTCSessionDescription(incomingCallData.offer));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    
    await db.ref(`/calls/${currentUser.uid}/answer`).set({ type: answer.type, sdp: answer.sdp });
    await db.ref(`/calls/${currentUser.uid}/status`).set('connected');

    const callerProfile = await fetchUserProfile(incomingCallData.callerId);
    showCallUI(callerProfile, incomingCallData.type, 'Connected');
    listenForIceCandidates(currentUser.uid, 'caller');
}

function handleRejectCall() {
    ringtone.pause();
    ringtone.currentTime = 0;
    document.getElementById('incoming-call-modal').style.display = 'none';
    
    logCall(incomingCallData.callerId, currentUser.uid, incomingCallData.type, 'rejected');
    db.ref(`/calls/${currentUser.uid}`).remove();
    incomingCallData = null;
}

function listenForIceCandidates(callPathUid, role) {
    const iceRef = db.ref(`/calls/${callPathUid}/iceCandidates/${role}`);
    activeListeners.iceCandidates = iceRef;
    
    iceRef.on('child_added', snapshot => {
        if (snapshot.exists() && peerConnection.signalingState !== 'closed') {
            peerConnection.addIceCandidate(new RTCIceCandidate(snapshot.val()));
        }
    });
}

function showCallUI(partner, type, status) {
    document.getElementById('call-view-emoji').textContent = partner.emoji;
    document.getElementById('call-view-name').textContent = partner.name;
    document.getElementById('call-view-status').textContent = status;

    if (type === 'voice') {
        document.getElementById('local-video').style.display = 'none';
        document.getElementById('remote-video').style.display = 'none';
        document.querySelector('.call-info').style.position = 'static';
        document.querySelector('.call-info').style.transform = 'none';
    } else {
        document.getElementById('local-video').style.display = 'block';
        document.getElementById('remote-video').style.display = 'block';
        document.querySelector('.call-info').style.position = 'absolute';
        document.querySelector('.call-info').style.transform = 'translateX(-50%)';
    }
    document.getElementById('call-view').style.display = 'flex';
}

function endCall() {
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    document.getElementById('call-view').style.display = 'none';
    document.getElementById('local-video').srcObject = null;
    document.getElementById('remote-video').srcObject = null;
    
    const callRef = db.ref(`/calls/`); 
    callRef.orderByChild('callerId').equalTo(currentUser.uid).once('value').then(snap => {
        if(snap.exists()) {
            const callKey = Object.keys(snap.val())[0];
            const callData = Object.values(snap.val())[0];
            logCall(callData.callerId, callData.calleeId, callData.type, 'completed');
            db.ref(`/calls/${callKey}`).remove();
        }
    });
    callRef.orderByChild('calleeId').equalTo(currentUser.uid).once('value').then(snap => {
         if(snap.exists()) {
            const callKey = Object.keys(snap.val())[0];
             const callData = Object.values(snap.val())[0];
            logCall(callData.callerId, callData.calleeId, callData.type, 'completed');
            db.ref(`/calls/${callKey}`).remove();
        }
    });

    if (activeListeners.callAnswer) activeListeners.callAnswer.off();
    if (activeListeners.iceCandidates) activeListeners.iceCandidates.off();
}

async function logCall(callerId, calleeId, type, status) {
    const callerProfile = await fetchUserProfile(callerId);
    const calleeProfile = await fetchUserProfile(calleeId);

    const log = {
        type,
        status,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    if(callerProfile && calleeProfile) {
        db.ref(`/callLogs/${callerId}`).push({ ...log, partner: { uid: calleeId, name: calleeProfile.name, emoji: calleeProfile.emoji } });
        db.ref(`/callLogs/${calleeId}`).push({ ...log, partner: { uid: callerId, name: callerProfile.name, emoji: callerProfile.emoji } });
    }
}


// --- UTILITY FUNCTIONS ---
function toggleTheme() {
    document.body.classList.toggle('light-theme');
    if (document.body.classList.contains('light-theme')) {
        localStorage.setItem('theme', 'light');
    } else {
        localStorage.removeItem('theme');
    }
}

function makeElementDraggable(elmnt) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    elmnt.onmousedown = dragMouseDown;

    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
    }
}
</script>
</body>
</html>
