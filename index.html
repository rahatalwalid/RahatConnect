<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RahatConnect</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Firebase v8 SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --bg-color: #FFFFFF;
            --text-color: #000000;
            --accent-color: #FFD700;
            --button-text-color: #000000;
            --secondary-bg-color: #F5F5F5;
            --border-color: #CED0D4;
        }
        .dark-mode {
            --bg-color: #18191A;
            --text-color: #E4E6EB;
            --secondary-bg-color: #242526;
            --border-color: #3A3B3C;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--secondary-bg-color); color: var(--text-color); }
        .hidden { display: none !important; }
        .app-container { width: 100%; min-height: 100vh; }
        
        /* Views */
        .view { display: none; flex-direction: column; width: 100%; min-height: 100vh; }
        .view.active { display: flex; }

        /* Authentication View */
        #auth-view { justify-content: center; align-items: center; padding: 2rem; background-color: var(--bg-color); }
        #auth-view h1 { font-size: 48px; font-weight: 700; color: var(--accent-color); margin-bottom: 2.5rem; }
        .auth-form { width: 100%; max-width: 380px; display: flex; flex-direction: column; gap: 1rem; }
        .auth-form input { width: 100%; padding: 14px 25px; border-radius: 25px; border: 2px solid var(--accent-color); background: transparent; color: var(--text-color); font-size: 1rem; outline: none; }
        .auth-form input::placeholder { color: var(--text-color); opacity: 0.6; }
        .auth-form button { padding: 14px; border-radius: 50px; border: none; background: var(--accent-color); color: var(--button-text-color); font-weight: bold; font-size: 1rem; cursor: pointer; }
        .auth-error { color: #ff3b30; font-size: 0.8rem; text-align: center; height: 1.2rem; }
        
        /* Main App Structure */
        .top-nav-bar { position: fixed; top: 0; left: 0; width: 100%; height: 55px; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); display: flex; justify-content: center; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .top-nav-inner { width: 100%; max-width: 1000px; display: flex; justify-content: space-around; }
        .top-nav-btn { padding: 0 15px; height: 100%; border: none; background: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: var(--text-color); opacity: 0.7; display: flex; align-items: center; border-bottom: 3px solid transparent; transition: all 0.2s ease; flex-shrink: 0; }
        .top-nav-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); opacity: 1; }
        .badge { background: red; color: white; font-size: 0.7rem; min-width: 18px; height: 18px; padding: 2px; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-left: 8px; }

        .main-content { width: 100%; padding-top: 55px; display: flex; justify-content: center; }
        .content-column { width: 100%; max-width: 680px; }
        
        .tab-content { display: none; flex-direction: column; width: 100%; }
        .tab-content.active { display: flex; }
        .inner-content { padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .tab-content h3 { color: var(--text-color); padding-bottom: 0.5rem; margin-bottom: 1rem; font-size: 1.5rem; border-bottom: 1px solid var(--border-color); }
        
        /* Components */
        .story-bar { display: flex; gap: 10px; padding: 1rem; background: var(--bg-color); border-radius: 8px; overflow-x: auto; border: 1px solid var(--border-color); }
        .story-circle { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; text-align: center; width: 70px; }
        .story-circle-img-container { width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--accent-color); padding: 2px; display: flex; justify-content: center; align-items: center; }
        .story-circle-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background-color: var(--secondary-bg-color); }
        
        .post-card { background-color: var(--bg-color); border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--border-color); }
        .post-header { display: flex; align-items: center; gap: 10px; padding: 12px; }
        .post-author-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .post-author-info .name { font-weight: 600; }
        .post-author-info .time { font-size: 0.75rem; opacity: 0.7; }
        .post-content { padding: 0 12px 12px; }
        .post-media { max-width: 100%; display: block; margin-top: 12px; border-radius: 8px; }
        .post-actions { display: flex; justify-content: space-around; padding: 4px; border-top: 1px solid var(--border-color); }
        .post-action-btn { flex: 1; background: none; border: none; color: var(--text-color); font-weight: 600; cursor: pointer; padding: 8px; border-radius: 8px; }
        .post-action-btn:hover { background-color: var(--secondary-bg-color); }

        .list-item { display: flex; align-items: center; padding: 0.8rem; background-color: var(--bg-color); border-radius: 10px; gap: 1rem; margin-bottom: 0.5rem; border: 1px solid var(--border-color); }
        .item-info { flex-grow: 1; }
        .item-actions button { padding: 5px 12px; border-radius: 15px; border: none; background-color: var(--accent-color); color: var(--button-text-color); font-weight: 600; cursor: pointer; }
        
        /* Profile View */
        .profile-header { position: relative; height: 35vh; max-height: 350px; background-color: var(--secondary-bg-color); }
        .profile-cover-img { width: 100%; height: 100%; object-fit: cover; }
        .profile-info-container { background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); }
        .profile-info { text-align: center; padding: 15px; padding-top: 75px; position: relative; max-width: 680px; margin: auto; }
        .profile-avatar { width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--bg-color); object-fit: cover; position: absolute; top: 0; left: 50%; transform: translate(-50%, -50%); }
        .profile-info h2 { font-size: 1.8rem; }
        .profile-info button { padding: 8px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; margin-top: 1rem; }
        
        /* Chat & Call Overlay Views */
        #chat-view, #call-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1100; background-color: var(--bg-color); transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        #chat-view.active, #call-view.active { transform: translateX(0); }
        .chat-header { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .chat-header .back-btn { font-size: 1.5rem; }
        .chat-header .contact-name { flex-grow: 1; text-align: center; font-weight: 600; }
        .messages-container { flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; }
        .message-bubble { max-width: 70%; padding: 8px 12px; border-radius: 18px; }
        .message-bubble.sent { background-color: var(--accent-color); color: var(--button-text-color); align-self: flex-end; }
        .message-bubble.received { background-color: var(--secondary-bg-color); align-self: flex-start; }
        .message-input-container { display: flex; padding: 10px; gap: 10px; border-top: 1px solid var(--border-color); }
        .message-input { flex-grow: 1; padding: 10px; border-radius: 20px; border: 1px solid var(--border-color); }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { width: 90%; max-width: 500px; padding: 2rem; border-radius: 10px; background-color: var(--bg-color); display: flex; flex-direction: column; gap: 1rem; }
        .modal-content textarea { width: 100%; min-height: 100px; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Auth View (dynamically populated) -->
        <div id="auth-view" class="view active"></div>

        <!-- Main App View -->
        <div id="main-app-view" class="view">
            <nav class="top-nav-bar">
                <div class="top-nav-inner">
                    <button class="top-nav-btn active" data-tab="home-tab">Home</button>
                    <button class="top-nav-btn" data-tab="friends-tab">Friends</button>
                    <button class="top-nav-btn" data-tab="chat-tab">Chat</button>
                    <button class="top-nav-btn" data-tab="search-tab">Search</button>
                    <button class="top-nav-btn" data-tab="profile-tab">Profile</button>
                </div>
            </nav>
            <main class="main-content">
                <div class="content-column">
                    <div id="home-tab" class="tab-content active">
                        <div class="inner-content">
                            <div class="story-bar" id="story-bar"></div>
                            <button id="create-post-btn">What's on your mind?</button>
                            <div id="feed-container"></div>
                        </div>
                    </div>
                    <div id="friends-tab" class="tab-content">
                        <div class="inner-content">
                            <h3>Friend Requests <span id="requests-count-badge" class="badge hidden">0</span></h3>
                            <div id="friend-requests-container"></div>
                            <h3>Suggestions</h3>
                            <div id="friend-suggestions-container"></div>
                        </div>
                    </div>
                    <div id="chat-tab" class="tab-content">
                        <div class="inner-content">
                           <h3>Messages</h3>
                           <div id="chat-list-container"></div>
                        </div>
                    </div>
                    <div id="search-tab" class="tab-content">
                        <div class="inner-content">
                            <h3>Find Friends</h3>
                            <div style="display:flex; gap: 5px;"><input type="text" id="search-input" placeholder="@username or Connect-xxxx"><button id="search-btn">Search</button></div>
                            <div id="search-results-container"></div>
                        </div>
                    </div>
                    <div id="profile-tab" class="tab-content">
                        <div class="profile-header"> <img id="profile-cover-img" class="profile-cover-img"> </div>
                        <div class="profile-info-container">
                            <div class="profile-info">
                                <img id="profile-avatar-img" class="profile-avatar">
                                <h2 id="profile-main-name"></h2>
                                <p id="profile-main-friendcode"></p>
                                <div style="margin-top: 1rem; display: flex; gap: 10px; justify-content: center;">
                                    <button id="edit-profile-btn">Edit Profile</button>
                                    <button id="logout-btn" style="background-color: #ff3b30; color: white;">Logout</button>
                                </div>
                            </div>
                        </div>
                        <div class="inner-content" id="user-posts-container"><h3>My Posts</h3></div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Overlay Views for Chat & Calls -->
        <div id="chat-view" class="view"></div>
        <div id="call-view" class="view"></div>
    </div>
    
    <!-- Modals -->
    <div id="profile-setup-modal" class="modal-overlay hidden"></div>
    <div id="create-post-modal" class="modal-overlay hidden"></div>
    <div id="edit-profile-modal" class="modal-overlay hidden"></div>
    
    <script>
        (() => {
            const firebaseConfig = {
                apiKey: "AIzaSyCyi55rVrsBtF9HpqMWz2a4H4ggwSkJ6z4",
                authDomain: "rahatconnect-e9755.firebaseapp.com",
                databaseURL: "https://rahatconnect-e9755-default-rtdb.firebaseio.com",
                projectId: "rahatconnect-e9755",
                storageBucket: "rahatconnect-e9755.appspot.com",
                messagingSenderId: "326989187761",
                appId: "1:326989187761:web:b2800fdbadb32b2a3af090"
            };

            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const firestore = firebase.firestore();
            const db = firebase.database();
            let currentUser = null;

            // --- UTILITY & RENDER FUNCTIONS ---
            window.showModal = (id, show = true) => document.getElementById(id)?.classList.toggle('hidden', !show);
            const showView = id => {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(id)?.classList.add('active');
            };
            const applyTheme = theme => {
                document.body.classList.toggle('dark-mode', theme === 'dark');
                localStorage.setItem('rahatconnect-theme', theme);
            };
            const fileToBase64 = file => new Promise((resolve, reject) => {
                if (file.size > 750000) return reject(new Error("Image is too large (max 750KB)."));
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });

            // --- AUTHENTICATION & INITIALIZATION ---
            auth.onAuthStateChanged(async user => {
                if (user) {
                    const userDocRef = firestore.collection('users').doc(user.uid);
                    let userDoc = await userDocRef.get();
                    if (!userDoc.exists) {
                        renderProfileSetupModal(user);
                        showModal('profile-setup-modal');
                    } else {
                        currentUser = { uid: user.uid, ...userDoc.data() };
                        initializeApp();
                    }
                } else {
                    currentUser = null;
                    renderAuthView();
                    showView('auth-view');
                }
            });

            function initializeApp() {
                showView('main-app-view');
                const savedTheme = localStorage.getItem('rahatconnect-theme') || 'light';
                applyTheme(savedTheme);
                attachAllListeners();
                loadAllData();
            }

            function loadAllData() {
                updateProfileView(); renderFeed(); renderFriendRequests(); renderFriendSuggestions(); renderChatList();
            }

            // --- DYNAMIC VIEW & MODAL RENDERING ---
            function renderAuthView() {
                document.getElementById('auth-view').innerHTML = `
                    <div id="login-form" class="auth-form">
                        <h1>RahatConnect</h1>
                        <input type="email" id="login-email" placeholder="Email"><input type="password" id="login-password" placeholder="Password">
                        <div class="auth-error" id="login-error"></div><button id="login-btn">Login</button>
                        <p class="auth-toggle-link">No account? <a id="show-signup">Signup</a></p>
                    </div>
                    <div id="signup-form" class="auth-form hidden">
                        <h1>RahatConnect</h1>
                        <input type="email" id="signup-email" placeholder="Email"><input type="password" id="signup-password" placeholder="Password">
                        <div class="auth-error" id="signup-error"></div><button id="signup-btn">Signup</button>
                        <p class="auth-toggle-link">Have an account? <a id="show-login">Login</a></p>
                    </div>`;
                document.getElementById('show-signup').onclick = () => { document.getElementById('login-form').classList.add('hidden'); document.getElementById('signup-form').classList.remove('hidden'); };
                document.getElementById('show-login').onclick = () => { document.getElementById('login-form').classList.remove('hidden'); document.getElementById('signup-form').classList.add('hidden'); };
                document.getElementById('login-btn').onclick = () => auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(e => document.getElementById('login-error').textContent = e.message);
                document.getElementById('signup-btn').onclick = () => auth.createUserWithEmailAndPassword(document.getElementById('signup-email').value, document.getElementById('signup-password').value).catch(e => document.getElementById('signup-error').textContent = e.message);
            }
            
            function renderProfileSetupModal(user) {
                 document.getElementById('profile-setup-modal').innerHTML = `
                    <div class="modal-content">
                        <h3>Welcome to RahatConnect!</h3><p>Let's set up your profile.</p>
                        <input type="text" id="setup-name" placeholder="Full Name" value="${user.email.split('@')[0]}">
                        <input type="text" id="setup-username" placeholder="Unique Username (e.g., @rahat)">
                        <input type="text" id="setup-emoji" placeholder="Your Emoji (e.g., 😊🔥)" maxlength="2">
                        <button id="save-setup-profile">Save & Continue</button>
                    </div>`;
                document.getElementById('save-setup-profile').onclick = async () => {
                    const name = document.getElementById('setup-name').value;
                    const username = document.getElementById('setup-username').value;
                    const emoji = document.getElementById('setup-emoji').value;
                    if(!name || !username || !emoji) return alert("All fields are required.");
                    const profileData = { name, emoji, username: username.startsWith('@') ? username : `@${username}`, friendCode: `Connect-${Math.floor(1000 + Math.random() * 9000)}`, email: user.email, avatarUrl: '', coverUrl: '', createdAt: firebase.firestore.FieldValue.serverTimestamp()};
                    await firestore.collection('users').doc(user.uid).set(profileData);
                    currentUser = { uid: user.uid, ...profileData };
                    showModal('profile-setup-modal', false);
                    initializeApp();
                };
            }

            // --- LISTENERS ---
            function attachAllListeners() {
                // Navigation
                document.querySelector('.top-nav-bar').onclick = e => {
                    const button = e.target.closest('.top-nav-btn');
                    if (!button) return;
                    document.querySelectorAll('.top-nav-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    document.getElementById(button.dataset.tab)?.classList.add('active');
                };
                
                // Main Buttons
                document.getElementById('create-post-btn').onclick = () => showModal('create-post-modal');
                document.getElementById('edit-profile-btn').onclick = () => renderEditProfileModal();
                document.getElementById('logout-btn').onclick = () => auth.signOut();
                document.getElementById('search-btn').onclick = searchFriends;
            }

            // --- PROFILE ---
            function updateProfileView() {
                const defaultAvatar = `https://ui-avatars.com/api/?name=${currentUser.name[0]}&background=FFD700&color=000`;
                document.getElementById('profile-main-name').textContent = currentUser.name;
                document.getElementById('profile-main-friendcode').textContent = currentUser.friendCode;
                document.getElementById('profile-avatar-img').src = currentUser.avatarUrl || defaultAvatar;
                document.getElementById('profile-cover-img').src = currentUser.coverUrl || 'https://via.placeholder.com/800x350?text=Cover+Image';
            }
            
            function renderEditProfileModal() {
                 document.getElementById('edit-profile-modal').innerHTML = `
                    <div class="modal-content">
                        <h3>Edit Profile</h3>
                        <label>Name</label><input type="text" id="edit-name-input" value="${currentUser.name}">
                        <label>Cover Image</label><input type="file" id="edit-cover-input" accept="image/*">
                        <label>Profile Picture</label><input type="file" id="edit-avatar-input" accept="image/*">
                        <hr><label>Theme</label>
                        <select id="theme-select">
                            <option value="light" ${localStorage.getItem('rahatconnect-theme') === 'light' ? 'selected' : ''}>Light</option>
                            <option value="dark" ${localStorage.getItem('rahatconnect-theme') === 'dark' ? 'selected' : ''}>Dark</option>
                        </select>
                        <button id="save-profile-changes-btn">Save</button>
                        <button class="secondary-btn" onclick="showModal('edit-profile-modal', false)">Cancel</button>
                    </div>`;
                document.getElementById('save-profile-changes-btn').onclick = async () => {
                    const updates = { name: document.getElementById('edit-name-input').value };
                    const coverFile = document.getElementById('edit-cover-input').files[0];
                    const avatarFile = document.getElementById('edit-avatar-input').files[0];
                    try {
                        if (coverFile) updates.coverUrl = await fileToBase64(coverFile);
                        if (avatarFile) updates.avatarUrl = await fileToBase64(avatarFile);
                        await firestore.collection('users').doc(currentUser.uid).update(updates);
                        currentUser = {...currentUser, ...updates};
                        updateProfileView();
                        showModal('edit-profile-modal', false);
                    } catch (error) { alert(error.message); }
                };
                document.getElementById('theme-select').onchange = (e) => applyTheme(e.target.value);
                showModal('edit-profile-modal');
            }
            
            // --- SOCIAL FEED & POSTS ---
            document.getElementById('create-post-modal').innerHTML = `
                <div class="modal-content">
                    <h3>Create Post</h3>
                    <textarea id="post-text-input" placeholder="What's on your mind?"></textarea>
                    <label>Upload Photo</label><input type="file" id="post-media-input" accept="image/*">
                    <button id="submit-post-btn">Post</button>
                    <button class="secondary-btn" onclick="showModal('create-post-modal', false)">Cancel</button>
                </div>`;
            document.getElementById('submit-post-btn').onclick = async () => {
                const text = document.getElementById('post-text-input').value.trim();
                const mediaFile = document.getElementById('post-media-input').files[0];
                if (!text && !mediaFile) return alert('Post is empty.');
                const postBtn = document.getElementById('submit-post-btn');
                postBtn.disabled = true; postBtn.textContent = 'Posting...';
                try {
                    const post = { authorId: currentUser.uid, authorName: currentUser.name, authorAvatar: currentUser.avatarUrl, text, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
                    if (mediaFile) post.mediaUrl = await fileToBase64(mediaFile);
                    await firestore.collection('posts').add(post);
                    showModal('create-post-modal', false);
                } catch (error) { alert(error.message); }
                finally { postBtn.disabled = false; postBtn.textContent = 'Post'; }
            };

            function renderFeed() {
                firestore.collection('posts').orderBy('timestamp', 'desc').limit(20).onSnapshot(snapshot => {
                    const feedContainer = document.getElementById('feed-container');
                    feedContainer.innerHTML = '';
                    snapshot.forEach(doc => feedContainer.appendChild(createPostElement(doc.data())));
                });
            }
            
            function createPostElement(post) {
                const card = document.createElement('div'); card.className = 'post-card';
                const time = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : 'Just now';
                const defaultAvatar = `https://ui-avatars.com/api/?name=${post.authorName[0]}`;
                card.innerHTML = `<div class="post-header"><img src="${post.authorAvatar || defaultAvatar}" class="post-author-img"><div class="post-author-info"><div class="name">${post.authorName}</div><div class="time">${time}</div></div></div><div class="post-content"><p>${post.text}</p>${post.mediaUrl ? `<img src="${post.mediaUrl}" class="post-media">` : ''}</div>`;
                return card;
            }

            // --- FRIENDS & SEARCH ---
            async function searchFriends() {
                const query = document.getElementById('search-input').value.trim();
                const resultsContainer = document.getElementById('search-results-container');
                resultsContainer.innerHTML = 'Searching...';
                let q;
                if(query.startsWith('@')) q = firestore.collection('users').where('username', '==', query);
                else if(query.toLowerCase().startsWith('connect-')) q = firestore.collection('users').where('friendCode', '==', query);
                else return resultsContainer.innerHTML = 'Invalid query format.';
                
                const snapshot = await q.get();
                if(snapshot.empty) return resultsContainer.innerHTML = 'No users found.';
                
                resultsContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    if(doc.id === currentUser.uid) return;
                    const user = doc.data();
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `<div class="item-info"><div class="name">${user.name}</div><div class="detail">${user.username}</div></div><div class="item-actions"><button data-uid="${doc.id}">Add Friend</button></div>`;
                    item.querySelector('button').onclick = (e) => {
                        db.ref(`requests/${doc.id}/${currentUser.uid}`).set({ fromName: currentUser.name, fromAvatar: currentUser.avatarUrl });
                        e.target.textContent = 'Sent'; e.target.disabled = true;
                    };
                    resultsContainer.appendChild(item);
                });
            }

            function renderFriendRequests() {
                db.ref(`requests/${currentUser.uid}`).on('value', snapshot => {
                    const container = document.getElementById('friend-requests-container');
                    const badge = document.getElementById('requests-count-badge');
                    if (!snapshot.exists()) {
                        container.innerHTML = '<p>No new requests.</p>';
                        badge.classList.add('hidden');
                        return;
                    }
                    container.innerHTML = '';
                    badge.textContent = snapshot.numChildren();
                    badge.classList.remove('hidden');
                    snapshot.forEach(childSnap => {
                        const req = childSnap.val();
                        const fromId = childSnap.key;
                        const item = document.createElement('div');
                        item.className = 'list-item';
                        item.innerHTML = `<div class="item-info"><div class="name">${req.fromName}</div></div><div class="item-actions"><button>Accept</button></div>`;
                        item.querySelector('button').onclick = async () => {
                            await db.ref(`friends/${currentUser.uid}/${fromId}`).set(true);
                            await db.ref(`friends/${fromId}/${currentUser.uid}`).set(true);
                            await db.ref(`requests/${currentUser.uid}/${fromId}`).remove();
                        };
                        container.appendChild(item);
                    });
                });
            }

            async function renderFriendSuggestions() {
                const friendsSnap = await db.ref(`friends/${currentUser.uid}`).once('value');
                const friendIds = Object.keys(friendsSnap.val() || {});
                friendIds.push(currentUser.uid); // Also exclude self

                const snapshot = await firestore.collection('users').limit(10).get();
                const container = document.getElementById('friend-suggestions-container');
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    if (!friendIds.includes(doc.id)) {
                        const user = doc.data();
                        const item = document.createElement('div');
                        item.className = 'list-item';
                        item.innerHTML = `<div class="item-info"><div class="name">${user.name}</div></div><div class="item-actions"><button>Add</button></div>`;
                        item.querySelector('button').onclick = (e) => {
                           db.ref(`requests/${doc.id}/${currentUser.uid}`).set({ fromName: currentUser.name });
                           e.target.textContent = 'Sent'; e.target.disabled = true;
                        };
                        container.appendChild(item);
                    }
                });
            }

            // --- CHAT & CALLS ---
            function renderChatList() {
                const container = document.getElementById('chat-list-container');
                db.ref(`friends/${currentUser.uid}`).on('value', snapshot => {
                    if (!snapshot.exists()) return container.innerHTML = '<p>No friends to chat with. Add some!</p>';
                    container.innerHTML = '';
                    snapshot.forEach(childSnap => {
                        const friendId = childSnap.key;
                        firestore.collection('users').doc(friendId).get().then(doc => {
                            if(!doc.exists) return;
                            const friend = doc.data();
                            const item = document.createElement('div');
                            item.className = 'list-item';
                            item.style.cursor = 'pointer';
                            item.innerHTML = `<div class="item-info"><div class="name">${friend.name}</div><div class="detail">${friend.username}</div></div>`;
                            item.onclick = () => openChatView(friendId, friend);
                            container.appendChild(item);
                        });
                    });
                });
            }

            function openChatView(peerId, peerData) {
                const chatId = [currentUser.uid, peerId].sort().join('_');
                const chatView = document.getElementById('chat-view');
                chatView.innerHTML = `
                    <div class="chat-header">
                        <button class="back-btn">←</button>
                        <div class="contact-name">${peerData.name}</div>
                        <button class="call-btn">Call</button>
                    </div>
                    <div class="messages-container"></div>
                    <div class="message-input-container">
                        <input class="message-input" placeholder="Type a message...">
                        <button class="send-btn">Send</button>
                    </div>
                `;
                chatView.classList.add('active');
                chatView.querySelector('.back-btn').onclick = () => chatView.classList.remove('active');
                chatView.querySelector('.send-btn').onclick = () => {
                    const input = chatView.querySelector('.message-input');
                    if(input.value) {
                        db.ref(`messages/${chatId}`).push({ text: input.value, senderId: currentUser.uid, timestamp: firebase.database.ServerValue.TIMESTAMP });
                        input.value = '';
                    }
                };

                const messagesContainer = chatView.querySelector('.messages-container');
                db.ref(`messages/${chatId}`).limitToLast(50).on('child_added', snap => {
                    const msg = snap.val();
                    const bubble = document.createElement('div');
                    bubble.className = `message-bubble ${msg.senderId === currentUser.uid ? 'sent' : 'received'}`;
                    bubble.textContent = msg.text;
                    messagesContainer.appendChild(bubble);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            }

        })();
    </script>
</body>
</html>
